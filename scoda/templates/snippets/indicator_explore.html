<script type="text/javascript">

    $(document).ready(function () {
        $('.js-example-basic-single').select2();
        $('.js-example-basic-multiple').select2();

        $('#Form').on('change', function () {

            var dataset_input = $('#dataset_id').find("option:selected").val();
            var indicator_input = $('#indicator_id').find("option:selected").val();
            var region_input = $('#region_id').find("option:selected").val();
            var type_input = $("#type_id").find("option:selected").val();
            var theme_input = $("#theme_id").find("option:selected").val();
            var year_input = $("#year").find("option:selected").val();

            $.getJSON('/_parse_data', {

                    dataset_id: dataset_input,
                    indicator_id: indicator_input,
                    region_id: region_input,
                    type_id: type_input,
                    theme_id: theme_input,
                    year: year_input

                },
                function (data) {
                    var datasets = data.dataset;
                    var indicators = data.indicator;
                    var regions = data.region;
                    var types = data.type;
                    var themes = data.theme;
                    var years = data.year;

                    $("#dataset_id").empty();
                    $("#indicator_id").empty();
                    $("#region_id").empty();
                    $("#type_id").empty();
                    $("#theme_id").empty();
                    $("#year").empty();

                    var options = $("#dataset_id");
                    options.empty()
                    datasets.forEach(function (item) {
                        options.append($('<option>', {value: item[0], text: item[1]}));
                    });

                    var options = $("#indicator_id");
                    options.empty()
                    indicators.forEach(function (item) {
                        options.append($('<option>', {value: item[0], text: item[1]}));
                    });

                    options = $("#region_id");
                    options.empty()
                    regions.forEach(function (item) {
                        options.append($('<option>', {value: item[0], text: item[1]}));
                    });

                    options = $("#type_id");
                    options.empty()
                    types.forEach(function (item) {
                        options.append($('<option>', {value: item[0], text: item[1]}));
                    });

                    options = $("#theme_id");
                    options.empty()
                    themes.forEach(function (item) {
                        options.append($('<option>', {value: item[0], text: item[1]}));
                    });

                    options = $("#year");
                    options.empty();
                    years.forEach(function (item) {
                        options.append($('<option>', {value: item[0], text: item[1]}));
                    });
                });
        });

    });

</script>

<div class="container-fluid">
    <div id="ui-view" style="opacity: 1;">
        <div class="animated fadeIn">
            <div class="row">
                <div class="col-sm-3 col-lg-3 col-lg-3">
                    <div class="card card-inverse card-primary">
                        <form action="{{ url_for('explore') }}" id="Form" class="form-horizontal" method="POST">
                            {{ form.hidden_tag() }}
                            <div class="form-group {% if form.dataset_id.errors %} has-error {% endif %}">
                                <div class="control-label">
                                    Data Set:
                                </div>
                                <div>
                                    {{ form.dataset_id(id='dataset_id',class="js-example-basic-single js-example-responsive",style="width: 100%") }}
                                </div>
                                <p class="help-block">
                                    {{ form.dataset_id.errors[0] }}
                            </div>

                            <div class="form-group {% if form.region_id.errors %} has-error {% endif %}">
                                <div class="control-label">
                                    Region:
                                </div>
                                <div>
                                    {{ form.region_id(id='region_id',class="js-example-basic-single js-example-responsive",style="width: 100%") }}
                                </div>
                                <p class="help-block">
                                    {{ form.region_id.errors[0] }}
                            </div>

                            <div class="form-group {% if form.type_id.errors %} has-error {% endif %}">
                                <div class="control-label">
                                    Region Type:
                                </div>
                                <div>
                                    {{ form.type_id(id='type_id',class="js-example-basic-single js-example-responsive",style="width: 100%") }}
                                </div>
                                <p class="help-block">
                                    {{ form.type_id.errors[0] }}
                            </div>

                            <div class="form-group {% if form.theme_id.errors %} has-error {% endif %}">
                                <div class="control-label">
                                    Theme:
                                </div>
                                <div>
                                    {{ form.theme_id(id='theme_id',class="js-example-basic-single js-example-responsive",style="width: 100%") }}
                                </div>
                                <p class="help-block">
                                    {{ form.theme_id.errors[0] }}
                            </div>

                            <div class="form-group {% if form.year.errors %} has-error {% endif %}">
                                <div class="control-label">
                                    Year:
                                </div>
                                <div>
                                    {{ form.year(id='year',class="js-example-basic-single js-example-responsive",style="width: 100%") }}
                                </div>
                                <p class="help-block">
                                    {{ form.year.errors[0] }}
                            </div>

                            <div class="form-group {% if form.indicator_id.errors %} has-error {% endif %}">
                                <div class="control-label">
                                    Indicator:
                                </div>
                                <div>
                                    {{ form.indicator_id(id='indicator_id',class="js-example-basic-single js-example-responsive",style="width: 100%") }}
                                </div>
                                <p class="help-block">
                                    {{ form.indicator_id.errors[0] }}
                            </div>

                            <button class="btn btn-success" type="submit">Explore This Indicator!</button>
                        </form>
                        <a href="{{ url_for('explore') }}">
                            <button class="btn btn-primary" id="clearForm">Reset Form</button>
                        </a>
                    </div>
                </div>

                {#                Plotting Card    #}

                {% if plot %}
                    <script>
                        function getImgData(chartContainer) {
                            var chartArea = chartContainer.children[0];
                            var svg = chartArea.innerHTML.substring(chartArea.innerHTML.indexOf("<svg"),
                                chartArea.innerHTML.indexOf("</svg>") + 6);
                            var doc = chartContainer.ownerDocument;
                            var canvas = doc.createElement('canvas');
                            canvas.setAttribute('width', chartArea.offsetWidth);
                            canvas.setAttribute('height', chartArea.offsetHeight);


                            canvas.setAttribute(
                                'style',
                                'position: absolute; ' +
                                'top: ' + (-chartArea.offsetHeight * 2) + 'px;' +
                                'left: ' + (-chartArea.offsetWidth * 2) + 'px;');
                            doc.body.appendChild(canvas);
                            canvg(canvas, svg);
                            var imgData = canvas.toDataURL("image/png");
                            canvas.parentNode.removeChild(canvas);
                            return imgData;
                        }

                        function saveAsImg(chartContainer) {
                            var imgData = getImgData(chartContainer);

                            // Replacing the mime-type will force the browser to trigger a download
                            // rather than displaying the image in the browser window.
                            window.location = imgData.replace("image/png", "image/octet-stream");
                        }

                        function toImg(chartContainer, imgContainer) {
                            var doc = chartContainer.ownerDocument;
                            var img = doc.createElement('img');
                            img.src = getImgData(chartContainer);

                            while (imgContainer.firstChild) {
                                imgContainer.removeChild(imgContainer.firstChild);
                            }
                            imgContainer.appendChild(img);
                        }
                    </script>

                    <script type="text/javascript">

                        google.charts.load('visualization', 'current', {
                            packages: ['controls', 'bar', 'corechart', 'geochart']
                        });

                        function redraw() {
                            console.log('Redraw!');
                            window.dispatchEvent(new Event('resize'));
                        }

                        function drawBar1() {

                            var data = google.visualization.arrayToDataTable({{ table|safe }})

                            var categoryPicker1 = new google.visualization.ControlWrapper({
                                'controlType': 'CategoryFilter',
                                'containerId': 'categorySelector1',
                                'state': {'selectedValues': []},
                                'options': {
                                    'filterColumnLabel': 'city',
                                    'ui': {
                                        'labelStacking': 'vertical',
                                        'allowMultiple': true,
                                        'allowNone': false,
                                        'allowTyping': false,
                                        'caption': 'Choose a city...'
                                    }
                                }
                            });

                            var categoryPicker2 = new google.visualization.ControlWrapper({
                                'controlType': 'CategoryFilter',
                                'containerId': 'categorySelector2',
                                'state': {'selectedValues': [{{ year|safe }}]},
                                'options': {
                                    'filterColumnLabel': 'year',
                                    'ui': {
                                        'labelStacking': 'vertical',
                                        'allowTyping': false,
                                        'allowMultiple': false,
                                        'allowNone': false
                                    }
                                }
                            });

                            var bar1 = new google.visualization.ChartWrapper({
                                'chartType': 'Bar',
                                'containerId': 'chart',
                                'options': {
                                    stacked: true,
                                    legend: 'right',
                                    bars: 'vertical',
                                    vAxis: {minValue: 0},
                                    series: {{ series|safe }}
                                },
                                view: {'columns': {{ view|safe }}}
                            });

                            var bar2 = new google.visualization.ChartWrapper({
                                'chartType': 'ColumnChart',
                                'containerId': 'chart_img',
                                'options': {
                                    height: '800',
                                    width: '1024',
                                    isStacked: true,
                                    legend: { position: 'right', maxLines: 10},
                                    chartArea: {left: '10%', right: '35%'},
                                    bars: 'vertical',
                                    vAxis: {minValue: 0},
                                    hAxis: {slantedText: true},
                                    series: {{ series|safe }}
                                },
                                view: {'columns': {{ view|safe }}}
                            });

                            var table1 = new google.visualization.ChartWrapper({
                                'chartType': 'Table',
                                'containerId': 'table',
                                'options': {}

                            });

                            var geochart1 = new google.visualization.ChartWrapper({
                                'chartType': 'GeoChart',
                                'containerId': 'geochart',
                                'options': {
                                    region: 'ZA',
                                    displayMode: 'markers',
                                    resolution: 'provinces',
                                    width: 640,
                                    height: 480,
                                    theme:'material'}
                            });


                            var dashboard = new google.visualization.Dashboard();
                            dashboard.bind([categoryPicker1, categoryPicker2], [bar1, bar2, table1]);
                            dashboard.draw(data);

                            function resize() {
                                dashboard.draw(data);
                            }

                            google.visualization.events.addListener(table1, 'ready', function () {

                                var dt = table1.getDataTable();
                                var csv = google.visualization.dataTableToCsv(dt);

                                $('#Export').click(function () {
                                    this.href = 'data:application/csv;charset=utf-8,' + encodeURIComponent(csv);
                                });

                                var myView = new google.visualization.DataView(dt);

                                myView.setColumns([0,2]);

                                geochart1.setDataTable(myView);
                                geochart1.draw()

                            });

                            if (window.addEventListener) {
                                window.addEventListener('resize', resize);
                            }

                            else {
                                window.attachEvent('onresize', resize);
                            }
                        }
                        google.setOnLoadCallback(drawBar1);

                    </script>

                    <div class="col-sm-9 col-lg-9 col-lg-6">
                        <div class="card card-inverse card-danger">
                            <div id="dashboard">
                                <div id="categorySelector1"></div>
                                <div id="categorySelector2"></div>
                                <div id="chart" style="display: none; margin: 0 auto; width: 100%;"></div>
                                <div id="chart_img" class="hidden" style="display: none; margin: 0 auto; width: 100%;"></div>
                                <div id="table" style="display: none; margin: 0 auto; width: 50%;"></div>
                                <div id="geochart" style="width: 900px; height: 500px;"></div>


                            </div>
                        </div>
                    </div>

                    <a id="Export" href="data.csv" target="_blank" download="data.csv">
                        <button class="btn-primary">Download as csv</button>
                    </a>

                    <button onclick="saveAsImg(document.getElementById('chart_img'));">Save as PNG Image</button>

                    </div>

                {% endif %}

        </div>
    </div>
</div>
</div>