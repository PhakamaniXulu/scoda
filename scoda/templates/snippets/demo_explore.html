<link rel="stylesheet" href="https://unpkg.com/leaflet@1.0.2/dist/leaflet.css"/>
<link rel="stylesheet" href="../../static/vendor/shepherd/css/shepherd-theme-dark.css"/>
<script src="https://unpkg.com/leaflet@1.0.2/dist/leaflet.js"></script>

<style>#map {
    width: 100%;
    height: 600px;
}

.info {
    padding: 6px 8px;
    font: 14px/16px Arial, Helvetica, sans-serif;
    background: white;
    background: rgba(255, 255, 255, 0.8);
    box-shadow: 0 0 15px rgba(0, 0, 0, 0.2);
    border-radius: 5px;
}

.info h4 {
    margin: 0 0 5px;
    color: #777;
}

.legend {
    text-align: left;
    line-height: 18px;
    color: #555;
}

.legend i {
    width: 18px;
    height: 18px;
    float: left;
    margin-right: 8px;
    opacity: 0.7;
}
</style>

<script type="text/javascript">

    $(document).ready(function () {
        $('.js-example-basic-single').select2();
        $('.js-example-basic-multiple').select2();

        {% if tour %}

        var tour = new Shepherd.Tour({
                defaults: {
                    classes: 'shepherd-theme-dark',
                    scrollTo: true
                }
            });

            tour.addStep('welcome', {
                title: 'Welcome to the Demographics Explorer!',
                text: 'This short tour will guide you through the necessary steps to explore the demographic modelling data contained in this almanac. You can exit the tour at any stage by clicking on the "Exit" button.',
                attachTo: '#formCardHead right',
                advanceOn: '.docs-link click',
                buttons: [
                    {
                        text: 'Exit',
                        action: tour.complete
                    },
                    {
                        text: 'Next',
                        action: tour.next
                    }
                ]
            });

            tour.addStep('form', {
                title: 'The Selection Form',
                text: 'This form is here to help you find the region you are interested in exploring. The selection fields will allow you to find the city, ward and year that you would like to explore. ',
                attachTo: '#formCard right',
                advanceOn: '.docs-link click',
                buttons: [
                    {
                        text: 'Back',
                        action: tour.back
                    },
                    {
                        text: 'Exit',
                        action: tour.complete
                    },
                    {
                        text: 'Next',
                        action: tour.next
                    }
                ]
            });

            tour.addStep('city', {
                title: 'City Selector',
                text: 'This field allows you to select the the city you would like to look at.',
                attachTo: '#city_label right',
                advanceOn: '.docs-link click',
                buttons: [
                    {
                        text: 'Back',
                        action: tour.back
                    },
                    {
                        text: 'Exit',
                        action: tour.complete
                    },
                    {
                        text: 'Next',
                        action: tour.next
                    }
                ]
            });

            tour.addStep('ward', {
                title: 'Ward Selector',
                text: 'This field allows you to select the ward that you would like to look at. Initially, and when "View All" is selected, the aggregated ward data will be shown. Selecting a particular ward and clicking "Submit" will zoom to that Ward and will show the small enumerator areas along with their data values.',
                attachTo: '#ward_label right',
                advanceOn: '.docs-link click',
                buttons: [
                    {
                        text: 'Back',
                        action: tour.back
                    },
                    {
                        text: 'Exit',
                        action: tour.complete
                    },
                    {
                        text: 'Next',
                        action: tour.next
                    }
                ]
            });

            tour.addStep('year', {
                title: 'Year Selector',
                text: 'This field allows you to choose which year\'s data values you would like to explore.',
                attachTo: '#year_label right',
                advanceOn: '.docs-link click',
                buttons: [
                    {
                        text: 'Back',
                        action: tour.back
                    },
                    {
                        text: 'Exit',
                        action: tour.complete
                    },
                    {
                        text: 'Next',
                        action: tour.next
                    }
                ]
            });

            tour.addStep('submit', {
                title: 'Submit Button',
                text: 'Once you have made your selections, click "Submit" to view the data!',
                attachTo: '#submitButton right',
                advanceOn: '.docs-link click',
                buttons: [
                    {
                        text: 'Back',
                        action: tour.back
                    },
                    {
                        text: 'Exit',
                        action: tour.complete
                    },
                    {
                        text: 'Next',
                        action: tour.next
                    }
                ]
            });

            tour.addStep('plot', {
                title: 'Map Area',
                text: 'This map shows projected migration values at the ward and small enumerator area levels for each metro. Clicking on an area will zoom to it, though clicking on a ward will NOT reveal its underlying enumerators.',
                attachTo: '#geoCard left',
                advanceOn: '.docs-link click',
                buttons: [
                    {
                        text: 'Back',
                        action: tour.back
                    },
                    {
                        text: 'Exit',
                        action: tour.complete
                    },
                    {
                        text: 'Next',
                        action: tour.next
                    }
                ]
            });

            tour.start();

        {% endif %}
    });

</script>

<div class="container-fluid">
    <div id="ui-view" style="opacity: 1;">
        <div class="animated fadeIn">
            <div class="row">
                <div class="col-sm-3 col-lg-3 col-lg-3">
                    <div class="card">
                        <div class="card-header" id="formCardHead">Area Selector</div>
                        <div class="card-block" id="formCard">
                            <form action="{{ url_for('demographics') }}" id="Form" class="form-horizontal" method="POST">
                                {{ form.csrf_token }}
                                {{ form.hidden_tag() }}
                                <div class="form-group {% if form.region_id.errors %} has-error {% endif %}">
                                    <div class="control-label" id="city_label">
                                        City Selection:
                                    </div>
                                    <div>
                                        {{ form.region_id(id='region_id',class="js-example-basic-single js-example-responsive",style="width: 100%") }}
                                    </div>
                                    <p class="help-block">
                                        {{ form.region_id.errors[0] }}
                                </div>

                                <div class="form-group {% if form.city_ward_code.errors %} has-error {% endif %}">
                                    <div class="control-label" id="ward_label">
                                        Ward Selection:
                                    </div>
                                    <div>
                                        {{ form.city_ward_code(id='region_id',class="js-example-basic-single js-example-responsive",style="width: 100%") }}
                                    </div>
                                    <p class="help-block">
                                        {{ form.city_ward_code.errors[0] }}
                                </div>

                                <div class="form-group {% if form.year.errors %} has-error {% endif %}">
                                    <div class="control-label" id="year_label">
                                        Year:
                                    </div>
                                    <div>
                                        {{ form.year(id='year',class="js-example-basic-single js-example-responsive",style="width: 100%") }}
                                    </div>
                                    <p class="help-block">
                                        {{ form.year.errors[0] }}
                                </div>
                                <button class="btn btn-success" type="submit" id="submitButton">Submit</button>
                            </form>
                        </div>
                    </div>
                </div>

                {# Plotting Card #}

                <div class="col-sm-9 col-lg-9 col-lg-9">
                    <div class="card" id="geoCard">
                        <div class="card-header">
                            Geographic Representation
                        </div>
                        <div class="card-block" style="padding: 0;">
                            <div id='map'></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script type="text/javascript"></script>

<script type="text/javascript">

    var map = L.map('map').setView([-26.195246, 28.034088], 10);

    L.tileLayer('http://{s}.tiles.wmflabs.org/bw-mapnik/{z}/{x}/{y}.png', {
        maxZoom: 19,
        attribution: 'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a>'
    }).addTo(map);


    // listen for when all features have been retrieved from the server

    // control that shows state info on hover
    var info = L.control();

    info.onAdd = function (map) {
        this._div = L.DomUtil.create('div', 'info');
        this.update();
        return this._div;
    };

    info.update = function (props) {
        this._div.innerHTML = '<h4>Demographic Model Data</h4>' + (props ?
            '<b>' + props.name + '</b><br />Migration Value for <b>' + props.year + '</b>: ' + props.density
                : 'Hover over a region');
    };

    info.addTo(map);


    // get color depending on population density value
    function getColor(d) {
        return d > 100000 ? '#800026' :
            d > 50000 ? '#BD0026' :
                d > 20000 ? '#E31A1C' :
                    d > 10000 ? '#FC4E2A' :
                        d > 5000 ? '#FD8D3C' :
                            d > 2000 ? '#FEB24C' :
                                d > 1000 ? '#FED976' :
                                    '#FFEDA0';
    }

    function style(feature) {
        return {
            weight: 2,
            opacity: 1,
            color: 'white',
            dashArray: '3',
            fillOpacity: 0.7,
            fillColor: getColor(feature.properties.density)
        };
    }

    function highlightFeature(e) {
        var layer = e.target;

        layer.setStyle({
            weight: 5,
            color: '#666',
            dashArray: '',
            fillOpacity: 0.7
        });

        if (!L.Browser.ie && !L.Browser.opera && !L.Browser.edge) {
            layer.bringToFront();
        }

        info.update(layer.feature.properties);
    }

    var geojson;

    function resetHighlight(e) {
        geojson.resetStyle(e.target);
        info.update();
    }

    function zoomToFeature(e) {
        map.fitBounds(e.target.getBounds());
    }

    function onEachFeature(feature, layer) {
        layer.on({
            mouseover: highlightFeature,
            mouseout: resetHighlight,
            click: zoomToFeature
        });
    }

    var statesData = {{ geometries|safe }}

        geojson = L.geoJson(statesData, {
            style: style,
            onEachFeature: onEachFeature
        }).addTo(map);


    map.fitBounds(geojson.getBounds());


    var legend = L.control({position: 'bottomright'});

    legend.onAdd = function (map) {

        var div = L.DomUtil.create('div', 'info legend'),
            grades = [0, 1000, 2000, 5000, 10000, 20000, 50000, 100000],
            labels = [],
            from, to;

        for (var i = 0; i < grades.length; i++) {
            from = grades[i];
            to = grades[i + 1];

            labels.push(
                '<i style="background:' + getColor(from + 1) + '"></i> ' +
                from + (to ? '&ndash;' + to : '+'));
        }

        div.innerHTML = labels.join('<br>');
        return div;
    };

    legend.addTo(map);

</script>

